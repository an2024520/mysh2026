#!/bin/sh

echo "ðŸ›‘ ç¬¬ä¸€æ­¥ï¼šæ¸…ç†æ—§é…ç½®..."
rc-service cloudflared stop
killall cloudflared 2>/dev/null
rm -f /etc/init.d/cloudflared
rm -f /etc/cloudflared/config.yml

echo "ðŸ“ ç¬¬äºŒæ­¥ï¼šè¯·è¾“å…¥ Token..."
echo "-------------------------------------------------------"
echo "è¯·ç²˜è´´ä»¥ 'eyJh' å¼€å¤´çš„å®Œæ•´ Tokenå­—ç¬¦ä¸²ï¼Œç„¶åŽæŒ‰å›žè½¦ï¼š"
read -r MY_TOKEN

# ç®€å•æ£€æŸ¥ Token æ˜¯å¦ä¸ºç©º
if [ -z "$MY_TOKEN" ]; then
    echo "âŒ é”™è¯¯ï¼šä½ æ²¡æœ‰è¾“å…¥ Tokenï¼è„šæœ¬é€€å‡ºã€‚"
    exit 1
fi

echo "âš™ï¸ ç¬¬ä¸‰æ­¥ï¼šå†™å…¥é…ç½®æ–‡ä»¶ (ä¿®å¤ int/string æ ¼å¼é”™è¯¯)..."
mkdir -p /etc/cloudflared

# æ ¸å¿ƒä¿®æ­£ï¼šedge-ip-version: "6" (åŠ äº†åŒå¼•å·ï¼Œè§£å†³ int æŠ¥é”™)
cat > /etc/cloudflared/config.yml <<EOF
tunnel: $MY_TOKEN
edge-ip-version: "6"
protocol: http2
logfile: /var/log/cloudflared.log
loglevel: info
EOF

echo "ðŸš€ ç¬¬å››æ­¥ï¼šé‡å†™å¯åŠ¨æœåŠ¡..."
# è¿™é‡Œçš„ command_args ç•™ç©ºï¼Œå¼ºåˆ¶å®ƒè¯»ä¸Šé¢çš„ config.yml
cat > /etc/init.d/cloudflared <<EOF
#!/sbin/openrc-run

name="cloudflared"
description="Cloudflare Tunnel Agent"
command="/usr/bin/cloudflared"
command_args="tunnel run"
command_background=true
pidfile="/run/cloudflared.pid"
output_log="/var/log/cloudflared.log"
error_log="/var/log/cloudflared.err"

depend() {
    need net
    after firewall
}
EOF
chmod +x /etc/init.d/cloudflared

echo "ðŸ”„ ç¬¬äº”æ­¥ï¼šå¯åŠ¨å¹¶éªŒè¯..."
rc-service cloudflared restart
sleep 5

echo "ðŸ“Š æ£€æŸ¥ç»“æžœ..."
# æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ ¼å¼é”™è¯¯
if grep -q "expected string found int" /var/log/cloudflared.err; then
    echo "âŒ å¤±è´¥ï¼šé…ç½®æ–‡ä»¶æ ¼å¼ä¾ç„¶ä¸å¯¹ã€‚"
# æ£€æŸ¥æ˜¯å¦æˆåŠŸ
elif grep -q "Registered tunnel connection" /var/log/cloudflared.err /var/log/cloudflared.log; then
    echo "âœ…âœ…âœ… æ­å–œï¼Tunnel å·²æˆåŠŸæ³¨å†Œå¹¶è¿žæŽ¥ï¼"
    echo "ä½ çš„ IPv6 èŠ‚ç‚¹åº”è¯¥å¤æ´»äº†ã€‚"
else
    echo "âš ï¸ çŠ¶æ€æœªçŸ¥ï¼Œè¯·æŸ¥çœ‹ä¸‹æ–¹æœ€æ–°æ—¥å¿—ï¼š"
    echo "--------------------------------"
    tail -n 10 /var/log/cloudflared.err
fi
