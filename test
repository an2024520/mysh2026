#!/bin/sh

echo "ğŸ›‘ ç¬¬ä¸€æ­¥ï¼šæ¸…ç†ç°åœº..."
# åœæ­¢æ‰€æœ‰æœåŠ¡ï¼Œé˜²æ­¢å†²çª
rc-service cloudflared stop
killall cloudflared 2>/dev/null
rm -f /etc/init.d/cloudflared

# æå– Token (é˜²æ­¢ä¸¢å¤±)
# å°è¯•ä»ä¹‹å‰çš„æ®‹ç•™æ–‡ä»¶ä¸­æ‰¾ Token
OLD_TOKEN=$(grep -o "ey[a-zA-Z0-9._-]*" /var/log/cloudflared.log 2>/dev/null | head -n 1)
# å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•ä» config.yml æ‰¾
if [ -z "$OLD_TOKEN" ]; then
    OLD_TOKEN=$(grep "tunnel:" /etc/cloudflared/config.yml 2>/dev/null | awk '{print $2}')
fi

# å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œè®©ç”¨æˆ·è¾“å…¥
if [ -z "$OLD_TOKEN" ]; then
    echo "âš ï¸ è‡ªåŠ¨æå– Token å¤±è´¥ã€‚"
    echo "è¯·æ‰‹åŠ¨ç²˜è´´ä½ çš„ Token (eyJh...): "
    read -r OLD_TOKEN
else
    echo "âœ… å·²æå– Token: ${OLD_TOKEN:0:10}..."
fi

echo "ğŸ“ ç¬¬äºŒæ­¥ï¼šå†™å…¥æ ‡å‡†é…ç½®æ–‡ä»¶..."
mkdir -p /etc/cloudflared
# å…³é”®ç‚¹ï¼šæŠŠæ‰€æœ‰å‚æ•°å†™åœ¨è¿™é‡Œï¼Œè€Œä¸æ˜¯æ”¾åœ¨å‘½ä»¤è¡Œå‚æ•°é‡Œ
cat > /etc/cloudflared/config.yml <<EOF
tunnel: $OLD_TOKEN
edge-ip-version: 6
protocol: http2
logfile: /var/log/cloudflared.log
loglevel: info
EOF

echo "âš™ï¸ ç¬¬ä¸‰æ­¥ï¼šé‡å†™å¯åŠ¨è„šæœ¬ (ä¸å¸¦å‚æ•°)..."
# æ³¨æ„ï¼šcommand_args è¿™é‡Œæˆ‘ä»¬ç•™ç©ºï¼åªè¿è¡Œ 'tunnel run'
# è¿™æ ·å®ƒå°±ä¼šå¼ºåˆ¶å»è¯» /etc/cloudflared/config.yml
cat > /etc/init.d/cloudflared <<EOF
#!/sbin/openrc-run

name="cloudflared"
description="Cloudflare Tunnel Agent"
command="/usr/bin/cloudflared"
command_args="tunnel run"
command_background=true
pidfile="/run/cloudflared.pid"
output_log="/var/log/cloudflared.log"
error_log="/var/log/cloudflared.err"

depend() {
    need net
    after firewall
}
EOF
chmod +x /etc/init.d/cloudflared

echo "ğŸš€ ç¬¬å››æ­¥ï¼šå¯åŠ¨å¹¶éªŒè¯..."
rc-service cloudflared restart
sleep 5

# æ£€æŸ¥æ—¥å¿—ï¼Œçœ‹æ˜¯å¦æˆåŠŸç»•è¿‡é™åˆ¶
if tail -n 10 /var/log/cloudflared.err | grep -q "network is unreachable"; then
    echo "âŒ å¤±è´¥ï¼šä¾ç„¶æç¤ºç½‘ç»œä¸å¯è¾¾ (IPv6 é…ç½®æœªç”Ÿæ•ˆ)"
    echo "æœ€åæŠ¥é”™ä¿¡æ¯ï¼š"
    tail -n 5 /var/log/cloudflared.err
else
    echo "âœ… ä¼¼ä¹æˆåŠŸäº†ï¼æ­£åœ¨æ£€æŸ¥è¿æ¥æ—¥å¿—..."
    grep "Registered tunnel connection" /var/log/cloudflared.err /var/log/cloudflared.log 2>/dev/null | tail -n 1
    echo "---------------------------------------------------"
    echo "è¯·æŸ¥çœ‹ä¸Šæ–¹æ˜¯å¦æœ‰ä¸€è¡Œ 'Registered tunnel connection'ã€‚"
    echo "å¦‚æœæœ‰ï¼Œæ­å–œä½ ï¼ŒTunnel å·²ç»æ‰“é€šï¼"
fi
